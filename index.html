<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>V0.1 FSGS-Friendly Foods</title>
    <meta content="#0f172a" name="theme-color" />
    <style>
        :root {
            --bg: #0b1020;
            --card: #121936;
            --muted: #94a3b8;
            --text: #e2e8f0;
            --brand: #22d3ee;
            --accent: #a78bfa;
            --danger: #ef4444;
            --ok: #22c55e;
            --warn: #f59e0b;
            --ring: 0 0 0 2px rgba(34, 211, 238, .35);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            margin: 0;
            height: 100%;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji
        }

        a {
            color: var(--brand)
        }

        .wrap {
            max-width: 960px;
            margin: 0 auto;
            padding: 14px
        }

        .header {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, rgba(11, 16, 32, .98), rgba(11, 16, 32, .75));
            backdrop-filter: saturate(140%) blur(6px);
            padding: 10px 14px;
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            z-index: 50
        }

        .title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: .2px
        }

        .subtitle {
            font-size: 12px;
            color: var(--muted)
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        button,
        .btn {
            border: 1px solid rgba(255, 255, 255, .12);
            background: #0f172a;
            color: var(--text);
            padding: 10px 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: .15s;
            display: inline-flex;
            align-items: center;
            gap: 8px
        }

        button:focus,
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            box-shadow: var(--ring);
        }

        button:hover {
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, .25)
        }

        .icon {
            font-style: normal;
            opacity: .9
        }

        .searchwrap {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 14px;
            padding: 8px 10px
        }

        .searchwrap input {
            flex: 1;
            border: 0;
            background: transparent;
            color: var(--text);
            font-size: 14px
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 14px
        }

        @media(min-width:700px) {
            .grid {
                grid-template-columns: 1fr 1fr
            }
        }

        .card {
            background: linear-gradient(180deg, #0f1731, #0e1838);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, .25)
        }

        .row {
            display: flex;
            align-items: start;
            gap: 10px;
            justify-content: space-between
        }

        .name {
            font-size: 16px;
            font-weight: 800
        }

        .serving {
            font-size: 12px;
            color: var(--muted)
        }

        .tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .tag {
            font-size: 11px;
            background: #0a1228;
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, .35);
            padding: 3px 8px;
            border-radius: 999px
        }

        .nutri {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px
        }

        @media(min-width:520px) {
            .nutri {
                grid-template-columns: repeat(5, 1fr)
            }
        }

        @media(min-width:860px) {
            .nutri {
                grid-template-columns: repeat(8, 1fr)
            }
        }

        .chip {
            background: #0b142f;
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            padding: 8px
        }

        .chip h4 {
            margin: 0;
            font-size: 11px;
            color: var(--muted);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .chip div {
            margin-top: 4px;
            font-weight: 800
        }

        .act {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px
        }

        .pill {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .15);
            background: #0a1024
        }

        .ok {
            color: var(--ok);
            border-color: rgba(34, 197, 94, .45)
        }

        .warn {
            color: var(--warn);
            border-color: rgba(245, 158, 11, .45)
        }

        .danger {
            color: var(--danger);
            border-color: rgba(239, 68, 68, .45)
        }

        .muted {
            color: var(--muted)
        }

        .footer {
            padding: 30px 12px;
            text-align: center;
            color: var(--muted);
            font-size: 12px
        }

        .bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
            align-items: center
        }

        .select {
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 12px;
            padding: 8px;
            color: var(--text);
            font-weight: 600
        }

        .select option {
            background: #0f172a;
            color: var(--text)
        }

        .hidden {
            display: none
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .grid2 label {
            font-size: 12px;
            color: var(--muted)
        }

        .grid2 input,
        .grid2 textarea {
            width: 100%;
            background: #0a132d;
            border: 1px solid rgba(255, 255, 255, .12);
            color: var(--text);
            padding: 10px;
            border-radius: 12px
        }

        .grid2 textarea {
            min-height: 80px
        }

        .flex-end {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px
        }

        .hl {
            border-bottom: 1px dashed rgba(148, 163, 184, .35);
            padding-bottom: 4px
        }

        #th-panel,
        #add-panel {
            margin-top: 12px;
        }

        /* 
        New flag pills (alt sweeteners / processed sugar / phosphates) */
        .flag-pills {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            margin-top: .55rem;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .22rem .5rem;
            border-radius: 9999px;
            font-size: .72rem;
            font-weight: 600;
            line-height: 1;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .pill .dot {
            width: .5rem;
            height: .5rem;
            border-radius: 9999px;
            opacity: .9;
        }

        .pill[data-type="sweetener"] {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .pill[data-type="sweetener"] .dot {
            background: #fb923c;
        }

        .pill[data-type="sugar"] {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .pill[data-type="sugar"] .dot {
            background: #ef4444;
        }

        .pill[data-type="phosphate"] {
            background: #eef2ff;
            border-color: #c7d2fe;
        }

        .pill[data-type="phosphate"] .dot {
            background: #6366f1;
        }

        .pill .lbl {
            letter-spacing: .01em;
        }

        .pill[title] {
            cursor: help;
        }




        /* === Readability upgrades for ingredient pills === */
        .flag-line {
            margin-top: 8px
        }

        .flag-line .label {
            display: inline-block;
            font-size: 12px;
            color: var(--muted);
            margin-right: 6px
        }

        .flag-pills {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem .55rem;
            /* row gap, column gap */
            align-items: center;
            margin-top: .55rem;
        }

        .pill {
            font-size: .8rem;
            /* larger text */
            font-weight: 800;
            /* heavier weight */
            padding: .32rem .6rem;
            /* roomier */
            border-radius: 9999px;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, .22);
            /* clearer outline */
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .18) inset;
            letter-spacing: .01em;
            filter: saturate(118%) contrast(110%);
            /* crisper */
        }

        .pill .dot {
            width: .55rem;
            height: .55rem;
            opacity: 1
        }

        /* Stronger foreground colors for each type */
        .pill[data-type="sweetener"] {
            background: #ffe8cf;
            border-color: #ffc996;
            color: #5d2e00
        }

        .pill[data-type="sweetener"] .dot {
            background: #ff7a1a
        }

        .pill[data-type="sugar"] {
            background: #ffe1e1;
            border-color: #ffbaba;
            color: #6e1111
        }

        .pill[data-type="sugar"] .dot {
            background: #e11d1d
        }

        .pill[data-type="phosphate"] {
            background: #e6ebff;
            border-color: #c2cffd;
            color: #18246f
        }

        .pill[data-type="phosphate"] .dot {
            background: #4654f2
        }

        /* Small helper so the whole group wraps neatly on small screens */
        @media (max-width:520px) {
            .flag-pills {
                gap: .45rem .45rem
            }

            .pill {
                font-size: .78rem
            }
        }






        .toast {
            position: fixed;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            background: #0b142f;
            border: 1px solid rgba(255, 255, 255, .15);
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s, transform .2s;
            z-index: 60
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px)
        }
    </style>
    <link href="manifest.json" rel="manifest" />
</head>

<body>
    <header class="header">
        <div>
            <div class="title">FSGS-Friendly Foods</div>
            <div class="subtitle">Track sodium, sugar, potassium, phosphorus, protein &amp; more</div>
        </div>
        <div aria-label="actions" class="controls" role="toolbar">
            <div aria-label="Search foods" class="searchwrap">
                <span class="icon">ðŸ”Ž</span>
                <input autocomplete="off" id="search" placeholder="Search foodsâ€¦ name or ingredient" type="search" />
            </div>
            <button id="btn-export" title="Export JSON"><span class="icon">ðŸ’¾</span>Export</button>
            <label class="btn" for="file-import" title="Import JSON"><span class="icon">ðŸ“¥</span>Import</label>
            <input accept="application/json" class="hidden" id="file-import" type="file" />
        </div>
    </header>
    <main class="wrap">
        <div class="bar">
            <select aria-label="Sort" class="select" id="sort">
                <option value="name">Sort: Name (Aâ†’Z)</option>
                <option value="sodium_mg">Sort: Sodium (mg)</option>
                <option value="potassium_mg">Sort: Potassium (mg)</option>
                <option value="phosphorus_mg">Sort: Phosphorus (mg)</option>
                <option value="protein_g">Sort: Protein (g)</option>
                <option value="sugar_g">Sort: Sugar (g)</option>
                <option value="calories_kcal">Sort: Calories (kcal)</option>
                <option value="carbs_g">Sort: Carbs (g)</option>
                <option value="fat_g">Sort: Fat (g)</option>
                <option value="fiber_g">Sort: Fiber (g)</option>
                <option value="cholesterol_mg">Sort: Cholesterol (mg)</option>
                <option value="calcium_mg">Sort: Calcium (mg)</option>
                <option value="magnesium_mg">Sort: Magnesium (mg)</option>
                <option value="vitamin_d_mcg">Sort: Vitamin D (mcg)</option>
            </select>
            <select aria-label="Quick filter" class="select" id="filter">
                <option value="all">View: All</option>
                <option value="low_sodium">Low Sodium</option>
                <option value="low_potassium">Low Potassium</option>
                <option value="low_phosphorus">Low Phosphorus</option>
                <option value="no_added_sugar">No Added Sugar</option>
            </select>
            <button class="btn" id="btn-add" title="Add a food"><span class="icon">âž•</span>Add</button>
            <button class="btn" id="btn-scan" title="Scan Barcode"><span class="icon">ðŸ“·</span>Scan</button>
            <button class="btn" id="btn-thresholds" title="Adjust thresholds"><span
                    class="icon">ðŸ› </span>Thresholds</button>
            <button class="btn" id="btn-reset" title="Clear search &amp; filters"><span
                    class="icon">ðŸ§¹</span>Reset</button>
            <button class="btn" id="btn-clear" title="Clear all data"><span class="icon">ðŸ—‘</span>Clear Data</button>
        </div>
        <!-- Add/Edit panel -->
        <section aria-label="Add or edit a food" class="card hidden" id="add-panel">
            <h3 id="add-title" style="margin:0 0 10px 0">Add Food</h3>
            <div class="grid2">
                <div>
                    <label for="f-name">Name</label>
                    <input id="f-name" placeholder="e.g., Broccoli, raw" />
                </div>
                <div>
                    <label for="f-serving">Serving Size</label>
                    <input id="f-serving" placeholder="e.g., 1 cup (91g)" />
                </div>
                <div>
                    <label for="f-sodium">Sodium (mg)</label>
                    <input id="f-sodium" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-potassium">Potassium (mg)</label>
                    <input id="f-potassium" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-phosphorus">Phosphorus (mg)</label>
                    <input id="f-phosphorus" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-protein">Protein (g)</label>
                    <input id="f-protein" inputmode="decimal" placeholder="0" />
                </div>
                <div>
                    <label for="f-sugar">Sugar (g)</label>
                    <input id="f-sugar" inputmode="decimal" placeholder="0" />
                </div>
                <!-- NEW fields -->
                <div>
                    <label for="f-calories">Calories (kcal)</label>
                    <input id="f-calories" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-carbs">Carbohydrates (g)</label>
                    <input id="f-carbs" inputmode="decimal" placeholder="0" />
                </div>
                <div>
                    <label for="f-fat">Fat (g)</label>
                    <input id="f-fat" inputmode="decimal" placeholder="0" />
                </div>
                <div>
                    <label for="f-fiber">Fiber (g)</label>
                    <input id="f-fiber" inputmode="decimal" placeholder="0" />
                </div>
                <div>
                    <label for="f-chol">Cholesterol (mg)</label>
                    <input id="f-chol" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-calcium">Calcium (mg)</label>
                    <input id="f-calcium" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-magnesium">Magnesium (mg)</label>
                    <input id="f-magnesium" inputmode="numeric" placeholder="0" />
                </div>
                <div>
                    <label for="f-vitd">Vitamin D (mcg)</label>
                    <input id="f-vitd" inputmode="decimal" placeholder="0" />
                </div>
                <div style="grid-column:1/-1">
                    <label for="f-ingredients">Ingredients</label>
                    <textarea id="f-ingredients" placeholder="Comma-separated (as on label)"></textarea>
                </div>
                <div style="grid-column:1/-1">
                    <label for="f-tags">Tags <span class="muted">(comma-separated, e.g. veg, grain)</span></label>
                    <input id="f-tags" placeholder="e.g., veg, protein" />
                </div>
                <div style="grid-column:1/-1">
                    <label for="f-notes">Notes</label>
                    <textarea id="f-notes" placeholder="Dietitian tips, frequency, reactions, etc."></textarea>
                </div>
            </div>
            <div class="flex-end">
                <button class="btn" id="btn-delete" style="margin-right:auto" type="button"><span
                        class="icon">ðŸ—‘</span>Delete</button>
                <button class="btn" id="btn-cancel" type="button"><span class="icon">âœ–</span>Cancel</button>
                <button class="btn" id="btn-save" type="button"><span class="icon">âœ…</span>Save</button>
            </div>
        </section>
        <!-- Thresholds panel (unchanged logic) -->
        <section aria-label="Thresholds editor" class="card hidden" id="th-panel">
            <h3 style="margin:0 0 10px 0">Thresholds &amp; Flags</h3>
            <div class="grid2">
                <div>
                    <label for="th-sodium">Low Sodium â‰¤ (mg / serving)</label>
                    <input id="th-sodium" inputmode="numeric" />
                </div>
                <div>
                    <label for="th-potassium">Low Potassium â‰¤ (mg / serving)</label>
                    <input id="th-potassium" inputmode="numeric" />
                </div>
                <div>
                    <label for="th-phosphorus">Low Phosphorus â‰¤ (mg / serving)</label>
                    <input id="th-phosphorus" inputmode="numeric" />
                </div>
                <div>
                    <label for="th-sugar">No-Added-Sugar flag if Sugar â‰¤ (g / serving)</label>
                    <input id="th-sugar" inputmode="decimal" />
                </div>
            </div>
            <div class="flex-end">
                <button class="btn" id="btn-th-cancel" type="button"><span class="icon">âœ–</span>Cancel</button>
                <button class="btn" id="btn-th-save" type="button"><span class="icon">ðŸ’¾</span>Save</button>
            </div>
        </section>
        <section aria-live="polite" class="grid" id="list"></section>
        <p class="footer">
            <span class="muted">Tip:</span> Tap an item to edit. All data stays on your device (localStorage). Export to
            back up or share.
            <br /><span class="muted">Disclaimer:</span> This app is not medical advice. Always verify labels and follow
            your clinician/dietitian guidance.
        </p>
    </main>
    <div aria-live="polite" class="toast" id="toast" role="status"></div>
    <script>
        (function () {
            const el = s => document.querySelector(s);
            const listEl = el('#list');
            const toastEl = el('#toast');

            // --- Storage Keys ---
            const STORAGE_KEY = 'fsgs_foods_v1'; // keep same key so existing data remains
            const THRESH_KEY = 'fsgs_thresholds_v1';

            const defaults = {
                thresholds: { sodium_mg: 140, potassium_mg: 200, phosphorus_mg: 150, sugar_g: 5 },
                sample: [
                    { id: uid(), name: 'Broccoli (raw)', serving: '1 cup (91g)', sodium_mg: 30, sugar_g: 1.5, potassium_mg: 316, phosphorus_mg: 60, protein_g: 2.6, calories_kcal: 31, carbs_g: 6, fat_g: 0.3, fiber_g: 2.4, cholesterol_mg: 0, calcium_mg: 43, magnesium_mg: 19, vitamin_d_mcg: 0, ingredients: 'broccoli', tags: ['veg'], notes: '' },
                    { id: uid(), name: 'Cauliflower (raw)', serving: '1 cup (107g)', sodium_mg: 32, sugar_g: 2.0, potassium_mg: 320, phosphorus_mg: 44, protein_g: 2.0, calories_kcal: 27, carbs_g: 5, fat_g: 0.3, fiber_g: 2.1, cholesterol_mg: 0, calcium_mg: 22, magnesium_mg: 16, vitamin_d_mcg: 0, ingredients: 'cauliflower', tags: ['veg'], notes: '' },
                    { id: uid(), name: 'White rice (cooked)', serving: '1/2 cup (80g)', sodium_mg: 0, sugar_g: 0, potassium_mg: 26, phosphorus_mg: 16, protein_g: 2.0, calories_kcal: 103, carbs_g: 22, fat_g: 0.2, fiber_g: 0.3, cholesterol_mg: 0, calcium_mg: 5, magnesium_mg: 8, vitamin_d_mcg: 0, ingredients: 'rice, water', tags: ['grain'], notes: '' },
                    { id: uid(), name: 'Egg whites (cooked)', serving: '3 tbsp (46g)', sodium_mg: 55, sugar_g: 0, potassium_mg: 70, phosphorus_mg: 6, protein_g: 3.6, calories_kcal: 25, carbs_g: 0.3, fat_g: 0.0, fiber_g: 0, cholesterol_mg: 0, calcium_mg: 3, magnesium_mg: 3, vitamin_d_mcg: 0, ingredients: 'egg whites', tags: ['protein'], notes: '' },
                    { id: uid(), name: 'Blueberries (raw)', serving: '1 cup (148g)', sodium_mg: 1, sugar_g: 15, potassium_mg: 114, phosphorus_mg: 18, protein_g: 1.1, calories_kcal: 84, carbs_g: 21, fat_g: 0.5, fiber_g: 3.6, cholesterol_mg: 0, calcium_mg: 9, magnesium_mg: 9, vitamin_d_mcg: 0, ingredients: 'blueberries', tags: ['fruit','anti-inflammatory'], notes: 'Rich in antioxidants' },
                    { id: uid(), name: 'Salmon (cooked)', serving: '3 oz (85g)', sodium_mg: 50, sugar_g: 0, potassium_mg: 370, phosphorus_mg: 200, protein_g: 19, calories_kcal: 175, carbs_g: 0, fat_g: 10, fiber_g: 0, cholesterol_mg: 60, calcium_mg: 10, magnesium_mg: 25, vitamin_d_mcg: 10, ingredients: 'salmon', tags: ['protein','anti-inflammatory'], notes: 'High in omega-3s' },
                    { id: uid(), name: 'Turmeric (ground)', serving: '1 tsp (3g)', sodium_mg: 1, sugar_g: 0, potassium_mg: 126, phosphorus_mg: 9, protein_g: 0.3, calories_kcal: 9, carbs_g: 2, fat_g: 0.3, fiber_g: 0.7, cholesterol_mg: 0, calcium_mg: 7, magnesium_mg: 2, vitamin_d_mcg: 0, ingredients: 'turmeric', tags: ['spice','anti-inflammatory'], notes: 'Contains curcumin' },
                    { id: uid(), name: 'Olive oil (extra virgin)', serving: '1 tbsp (14g)', sodium_mg: 0, sugar_g: 0, potassium_mg: 0, phosphorus_mg: 0, protein_g: 0, calories_kcal: 119, carbs_g: 0, fat_g: 14, fiber_g: 0, cholesterol_mg: 0, calcium_mg: 0, magnesium_mg: 0, vitamin_d_mcg: 0, ingredients: 'olive oil', tags: ['fat','anti-inflammatory'], notes: 'Healthy monounsaturated fats' },
                    { id: uid(), name: 'Spinach (raw)', serving: '1 cup (30g)', sodium_mg: 24, sugar_g: 0.1, potassium_mg: 167, phosphorus_mg: 15, protein_g: 0.9, calories_kcal: 7, carbs_g: 1, fat_g: 0.1, fiber_g: 0.7, cholesterol_mg: 0, calcium_mg: 30, magnesium_mg: 24, vitamin_d_mcg: 0, ingredients: 'spinach', tags: ['veg','anti-inflammatory'], notes: 'Rich in antioxidants & iron' }
]
            };

            // --- State ---
            let foods = loadFoods();
            let thresholds = loadThresholds();
            let editingId = null;

            // --- Elements ---
            const searchInput = el('#search');
            const sortSel = el('#sort');
            const filterSel = el('#filter');
            const btnAdd = el('#btn-add');
            const btnExport = el('#btn-export');
            const fileImport = el('#file-import');
            const btnReset = el('#btn-reset');
            const btnTh = el('#btn-thresholds');

            // Thresholds panel
            const thPanel = el('#th-panel');
            const thSodium = el('#th-sodium');
            const thPotassium = el('#th-potassium');
            const thPhosphorus = el('#th-phosphorus');
            const thSugar = el('#th-sugar');
            const btnThSave = el('#btn-th-save');
            const btnThCancel = el('#btn-th-cancel');

            // Add/Edit panel
            const addPanel = el('#add-panel');
            const addTitle = el('#add-title');
            const fName = el('#f-name');
            const fServing = el('#f-serving');
            const fSodium = el('#f-sodium');
            const fPotassium = el('#f-potassium');
            const fSugar = el('#f-sugar');
            const fPhosphorus = el('#f-phosphorus');
            const fProtein = el('#f-protein');
            const fCalories = el('#f-calories');
            const fCarbs = el('#f-carbs');
            const fFat = el('#f-fat');
            const fFiber = el('#f-fiber');
            const fChol = el('#f-chol');
            const fCalcium = el('#f-calcium');
            const fMagnesium = el('#f-magnesium');
            const fVitD = el('#f-vitd');
            const fIngredients = el('#f-ingredients');
            const fTags = el('#f-tags');
            const fNotes = el('#f-notes');
            const btnSave = el('#btn-save');
            const btnCancel = el('#btn-cancel');
            const btnDelete = el('#btn-delete');

            /* =========================
               NEW: Ingredient scanner (Alt Sweeteners / Sugar-HFCS / Phosphates)
               ========================= */
            const FLAG_CONFIG = {
                sweeteners: [
                    "erythritol", "xylitol", "sorbitol", "mannitol", "maltitol", "isomalt", "lactitol",
                    "aspartame", "acesulfame\\s*-?\\s*K", "acesulfame", "sucralose", "saccharin", "cyclamate",
                    "neotame", "advantame", "stevia", "rebaudioside\\s*-?\\s*A", "monk\\s*fruit", "luo\\s*han\\s*guo",
                    "agave\\s*syrup", "brown\\s*rice\\s*syrup", "date\\s*syrup", "yacon\\s*syrup"
                ],
                sugars: [
                    "high\\s*-?\\s*fructose\\s*corn\\s*syrup", "hfcs",
                    "corn\\s*syrup", "corn\\s*syrup\\s*solids", "invert\\s*sugar", "invert\\s*syrup",
                    "glucose\\s*syrup", "fructose\\s*syrup", "malt\\s*syrup",
                    "sugar", "cane\\s*sugar", "brown\\s*sugar", "granulated\\s*sugar", "raw\\s*sugar",
                    "sucrose", "glucose", "fructose", "dextrose", "maltose", "lactose",
                    "molasses", "treacle", "honey", "maple\\s*syrup", "golden\\s*syrup"
                ],
                phosphates: [
                    "phosphate", "phosphates",
                    "sodium\\s*phosphate", "disodium\\s*phosphate", "trisodium\\s*phosphate",
                    "monosodium\\s*phosphate", "tetrasodium\\s*pyrophosphate", "sodium\\s*acid\\s*pyrophosphate", "sapp",
                    "dipotassium\\s*phosphate", "tripotassium\\s*phosphate",
                    "calcium\\s*phosphate", "monocalcium\\s*phosphate", "dicalcium\\s*phosphate", "tricalcium\\s*phosphate",
                    "aluminum\\s*phosphate", "ammonium\\s*phosphate",
                    "phosphoric\\s*acid"
                ]
            };
            const RX_from = list => list.map(tok => new RegExp(`(?:^|[^a-z0-9])(${tok})(?=[^a-z0-9]|$)`, 'i'));
            function scanIngredients(text) {
                const t = (text || '').toLowerCase();
                const find = (rxs) => {
                    const out = new Set();
                    for (const rx of rxs) {
                        const m = t.match(rx);
                        if (m && m[1]) out.add(m[1].trim());
                    }
                    return [...out];
                };
                return {
                    sweetener: find(RX_from(FLAG_CONFIG.sweeteners)),
                    sugar: find(RX_from(FLAG_CONFIG.sugars)),
                    phosphate: find(RX_from(FLAG_CONFIG.phosphates))
                };
            }
            function makePill(type, label, items) {
                if (!items.length) return '';
                const title = `${label}: ${items.join(', ')}`.replace(/"/g, '&quot;');
                return `<span class="pill" data-type="${type}" title="${title}"><span class="dot"></span><span class="lbl">${label}</span></span>`;
            }
            function pillsHTML(flags) {
                return [
                    makePill('sweetener', 'Alt Sweetener', flags.sweetener),
                    makePill('sugar', 'Processed Sugar/HFCS', flags.sugar),
                    makePill('phosphate', 'Phosphate', flags.phosphate)
                ].join('');
            }
            /* ========================= */

            // --- Init ---
            render();

            // --- Events ---
            searchInput.addEventListener('input', debounce(render, 150));
            sortSel.addEventListener('change', render);
            filterSel.addEventListener('change', render);

            btnReset.addEventListener('click', () => {
                closeAddPanel();
                closeThPanel();
                searchInput.value = '';
                filterSel.value = 'all';
                sortSel.value = 'name';
                render();
            });

            btnAdd.addEventListener('click', () => {
                if (addPanel.classList.contains('hidden')) { openAddPanel(); } else { closeAddPanel(); }
            });

            btnExport.addEventListener('click', onExport);
            fileImport.addEventListener('change', onImport);

            
            const btnClear = document.querySelector('#btn-clear');
            btnClear.addEventListener('click', () => {
                if (confirm("Clear all saved foods and reload defaults?")) {
                    localStorage.removeItem(STORAGE_KEY);
                    foods = [...defaults.sample];
                    saveFoods();
                    render();
                    toast('Data cleared, defaults restored');
                }
            });

// Thresholds toggle
            btnTh.addEventListener('click', () => { if (thPanel.classList.contains('hidden')) openThPanel(); else closeThPanel(); });
            btnThSave.addEventListener('click', (e) => { e.stopPropagation(); saveThresholds(); });
            btnThCancel.addEventListener('click', (e) => { e.stopPropagation(); closeThPanel(); });

            btnSave.addEventListener('click', saveItem);
            btnCancel.addEventListener('click', (e) => { e.stopPropagation(); closeAddPanel(); });
            btnDelete.addEventListener('click', deleteItem);

            // Close with ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!thPanel.classList.contains('hidden')) closeThPanel();
                    if (!addPanel.classList.contains('hidden')) closeAddPanel();
                }
            });

            // --- Functions ---
            function uid() { return Math.random().toString(36).slice(2, 10); }

            function loadFoods() {
    return [...defaults.sample];
}
                    const merged = Object.values(byName);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));
                    return merged;
                } catch {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaults.sample));
                    return [...defaults.sample];
                }
            }
                    const arr = JSON.parse(raw);
                    return Array.isArray(arr) ? arr : [...defaults.sample];
                } catch { return [...defaults.sample]; }
            }
            function saveFoods() {
    // disabled: no localStorage
}

            function loadThresholds() {
                try {
                    const raw = localStorage.getItem(THRESH_KEY);
                    if (!raw) { localStorage.setItem(THRESH_KEY, JSON.stringify(defaults.thresholds)); return { ...defaults.thresholds }; }
                    const t = JSON.parse(raw);
                    return {
                        sodium_mg: toNumOr(defaults.thresholds.sodium_mg, t.sodium_mg),
                        potassium_mg: toNumOr(defaults.thresholds.potassium_mg, t.potassium_mg),
                        phosphorus_mg: toNumOr(defaults.thresholds.phosphorus_mg, t.phosphorus_mg),
                        sugar_g: toNumOr(defaults.thresholds.sugar_g, t.sugar_g)
                    };
                } catch { return { ...defaults.thresholds }; }
            }

            function openAddPanel(item) {
                window.openAddPanel = openAddPanel;
                editingId = item?.id ?? null;
                addTitle.textContent = editingId ? 'Edit Food' : 'Add Food';
                fName.value = item?.name ?? '';
                fServing.value = item?.serving ?? '';
                fSodium.value = item?.sodium_mg ?? '';
                fSugar.value = item?.sugar_g ?? '';
                fPotassium.value = item?.potassium_mg ?? '';
                fPhosphorus.value = item?.phosphorus_mg ?? '';
                fProtein.value = item?.protein_g ?? '';
                fCalories.value = item?.calories_kcal ?? '';
                fCarbs.value = item?.carbs_g ?? '';
                fFat.value = item?.fat_g ?? '';
                fFiber.value = item?.fiber_g ?? '';
                fChol.value = item?.cholesterol_mg ?? '';
                fCalcium.value = item?.calcium_mg ?? '';
                fMagnesium.value = item?.magnesium_mg ?? '';
                fVitD.value = item?.vitamin_d_mcg ?? '';
                fIngredients.value = item?.ingredients ?? '';
                fTags.value = (item?.tags || []).join(', ');
                fNotes.value = item?.notes ?? '';
                btnDelete.style.display = editingId ? 'inline-flex' : 'none';

                addPanel.classList.remove('hidden');
                setTimeout(() => fName.focus({ preventScroll: true }), 0);
            }
            function closeAddPanel() {
                if (addPanel.contains(document.activeElement)) { (document.querySelector('#search') || document.body).focus({ preventScroll: true }); }
                addPanel.classList.add('hidden');
            }

            function openThPanel() {
                thSodium.value = thresholds.sodium_mg;
                thPotassium.value = thresholds.potassium_mg;
                thPhosphorus.value = thresholds.phosphorus_mg;
                thSugar.value = thresholds.sugar_g;
                thPanel.classList.remove('hidden');
                setTimeout(() => thSodium.focus({ preventScroll: true }), 0);
            }
            function closeThPanel() {
                if (thPanel.contains(document.activeElement)) { (document.querySelector('#search') || document.body).focus({ preventScroll: true }); }
                thPanel.classList.add('hidden');
            }

            function num(v) { const n = parseFloat(v); return Number.isFinite(n) ? n : 0; }
            function toNumOr(fallback, v) { const n = parseFloat(v); return Number.isFinite(n) ? n : fallback; }

            function saveItem() {
                const item = {
                    id: editingId ?? uid(),
                    name: fName.value.trim(),
                    serving: fServing.value.trim(),
                    sodium_mg: num(fSodium.value),
                    sugar_g: num(fSugar.value),
                    potassium_mg: num(fPotassium.value),
                    phosphorus_mg: num(fPhosphorus.value),
                    protein_g: num(fProtein.value),
                    calories_kcal: num(fCalories.value),
                    carbs_g: num(fCarbs.value),
                    fat_g: num(fFat.value),
                    fiber_g: num(fFiber.value),
                    cholesterol_mg: num(fChol.value),
                    calcium_mg: num(fCalcium.value),
                    magnesium_mg: num(fMagnesium.value),
                    vitamin_d_mcg: num(fVitD.value),
                    ingredients: fIngredients.value.trim(),
                    tags: fTags.value.split(',').map(t => t.trim()).filter(Boolean),
                    notes: fNotes.value.trim()
                };
                if (!item.name) { alert('Name is required.'); return; }
                if (editingId) {
                    const i = foods.findIndex(x => x.id === editingId);
                    if (i >= 0) foods[i] = item;
                } else {
                    foods.unshift(item);
                }
                saveFoods();
                closeAddPanel();
                toast('Saved');
                render();
            }

            function deleteItem() {
                if (!editingId) return closeAddPanel();
                const i = foods.findIndex(x => x.id === editingId);
                if (i >= 0) foods.splice(i, 1);
                saveFoods();
                closeAddPanel();
                toast('Deleted');
                render();
            }

            function saveThresholds() {
                const next = {
                    sodium_mg: toNumOr(thresholds.sodium_mg, thSodium.value),
                    potassium_mg: toNumOr(thresholds.potassium_mg, thPotassium.value),
                    phosphorus_mg: toNumOr(thresholds.phosphorus_mg, thPhosphorus.value),
                    sugar_g: toNumOr(thresholds.sugar_g, thSugar.value)
                };
                thresholds = next;
                try { localStorage.setItem(THRESH_KEY, JSON.stringify(thresholds)); } catch { }
                closeThPanel();
                toast('Thresholds saved');
                render();
            }

            function onExport() {
                const data = { foods, thresholds };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'fsgs_foods_export.json';
                a.click();
                URL.revokeObjectURL(a.href);
                toast('Exported data');
            }

            function onImport(e) {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        if (Array.isArray(data)) {
                            foods = data.map(upgradeItemSchema);
                        } else {
                            if (Array.isArray(data.foods)) foods = data.foods.map(upgradeItemSchema);
                            if (data.thresholds) thresholds = { ...thresholds, ...data.thresholds };
                        }
                        saveFoods();
                        localStorage.setItem(THRESH_KEY, JSON.stringify(thresholds));
                        render();
                        toast('Imported data');
                    } catch (err) { alert('Import failed. Ensure valid JSON export.'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            }

            function upgradeItemSchema(x) {
                // Ensure new fields exist when importing older exports
                return {
                    calories_kcal: 0, carbs_g: 0, fat_g: 0, fiber_g: 0, cholesterol_mg: 0, calcium_mg: 0, magnesium_mg: 0, vitamin_d_mcg: 0, notes: '',
                    ...x,
                    // Coerce numeric fields (avoids NaN rendering)
                    sodium_mg: num(x.sodium_mg), sugar_g: num(x.sugar_g), potassium_mg: num(x.potassium_mg), phosphorus_mg: num(x.phosphorus_mg), protein_g: num(x.protein_g),
                    calories_kcal: num(x.calories_kcal), carbs_g: num(x.carbs_g), fat_g: num(x.fat_g), fiber_g: num(x.fiber_g), cholesterol_mg: num(x.cholesterol_mg), calcium_mg: num(x.calcium_mg), magnesium_mg: num(x.magnesium_mg), vitamin_d_mcg: num(x.vitamin_d_mcg)
                };
            }

            function flagClass(val, limit) {
                if (val <= limit) return 'ok';
                if (val <= limit * 1.5) return 'warn';
                return 'danger';
            }

            function passFilters(item) {
                const f = filterSel.value;
                if (f === 'all') return true;
                if (f === 'low_sodium') return item.sodium_mg <= thresholds.sodium_mg;
                if (f === 'low_potassium') return item.potassium_mg <= thresholds.potassium_mg;
                if (f === 'low_phosphorus') return item.phosphorus_mg <= thresholds.phosphorus_mg;
                if (f === 'no_added_sugar') return item.sugar_g <= thresholds.sugar_g;
                return true;
            }

            function render() {
                const q = searchInput.value.trim().toLowerCase();
                const sortBy = sortSel.value;

                let view = foods.map(upgradeItemSchema).filter(passFilters).filter(x => {
                    if (!q) return true;
                    return (
                        x.name.toLowerCase().includes(q) ||
                        (x.ingredients || '').toLowerCase().includes(q) ||
                        (x.serving || '').toLowerCase().includes(q)
                    );
                });

                view.sort((a, b) => {
                    if (sortBy === 'name') return a.name.localeCompare(b.name);
                    return (a[sortBy] ?? 0) - (b[sortBy] ?? 0);
                });

                listEl.innerHTML = '';
                if (view.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'card';
                    empty.innerHTML = '<div class="hl">No items found</div><div class="muted" style="margin-top:6px">Use âž• Add to create foods or import a JSON file.</div>';
                    listEl.appendChild(empty);
                    return;
                }

                for (const item of view) {
                    const card = document.createElement('article');
                    card.className = 'card';
                    card.tabIndex = 0; card.setAttribute('role', 'button'); card.setAttribute('aria-label', 'Edit ' + item.name);

                    const sodiumCls = flagClass(item.sodium_mg, thresholds.sodium_mg);
                    const potCls = flagClass(item.potassium_mg, thresholds.potassium_mg);
                    const phosCls = flagClass(item.phosphorus_mg, thresholds.phosphorus_mg);
                    const sugarCls = flagClass(item.sugar_g, thresholds.sugar_g);

                    // NEW: pills for ingredient flags
                    const flags = scanIngredients(item.ingredients || '');
                    const flagPills = pillsHTML(flags);

                    card.innerHTML = `
                        <div class="row">
                        <div>
                            <div class="name">${escapeHtml(item.name)}</div>
                            <div class="serving">${escapeHtml(item.serving || '')}</div>
                            <div class="tags">${(item.tags || []).map(t => `<span class=\"tag\">${escapeHtml(t)}</span>`).join('')}</div>
                        </div>
                        <div class="act">
                            <span class="pill ${sodiumCls}" title="Sodium ${item.sodium_mg} mg">Na ${item.sodium_mg || 0} mg</span>
                            <span class="pill ${sugarCls}" title="Sugar ${item.sugar_g} g">Sugar ${item.sugar_g || 0} g</span>
                            <span class="pill" title="Calories ${item.calories_kcal} kcal">${item.calories_kcal || 0} kcal</span>
                        </div>
                        </div>
                        <div class="nutri">
                        <div class="chip"><h4>Sodium</h4><div class="${sodiumCls}">${item.sodium_mg || 0} mg</div></div>
                        <div class="chip"><h4>Potassium</h4><div class="${potCls}">${item.potassium_mg || 0} mg</div></div>
                        <div class="chip"><h4>Phosphorus</h4><div class="${phosCls}">${item.phosphorus_mg || 0} mg</div></div>
                        <div class="chip"><h4>Sugar</h4><div class="${sugarCls}">${item.sugar_g || 0} g</div></div>
                        <div class="chip"><h4>Protein</h4><div>${item.protein_g || 0} g</div></div>
                        <div class="chip"><h4>Calories</h4><div>${item.calories_kcal || 0} kcal</div></div>
                        <div class="chip"><h4>Carbs</h4><div>${item.carbs_g || 0} g</div></div>
                        <div class="chip"><h4>Fat</h4><div>${item.fat_g || 0} g</div></div>
                        <div class="chip"><h4>Fiber</h4><div>${item.fiber_g || 0} g</div></div>
                        <div class="chip"><h4>Cholest.</h4><div>${item.cholesterol_mg || 0} mg</div></div>
                        <div class="chip"><h4>Calcium</h4><div>${item.calcium_mg || 0} mg</div></div>
                        <div class="chip"><h4>Magnesium</h4><div>${item.magnesium_mg || 0} mg</div></div>
                        <div class="chip"><h4>Vit D</h4><div>${item.vitamin_d_mcg || 0} mcg</div></div>
                        </div>
                        <div class="hl" style="margin-top:10px"></div>
                        <div class="serving" style="margin-top:8px"><span class="muted">Ingredients:</span> ${escapeHtml(item.ingredients || '')}</div>
                        ${flagPills ? `<div class="flag-pills">${flagPills}</div>` : ``}
                        ${item.notes ? `<div class=\"serving\" style=\"margin-top:6px\"><span class=\"muted\">Notes:</span> ${escapeHtml(item.notes)}</div>` : ''}
                    `;

                    card.addEventListener('click', () => openAddPanel(item));
                    card.addEventListener('keypress', (e) => { if (e.key === 'Enter') openAddPanel(item); });
                    listEl.appendChild(card);
                }
            }

            function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, a), ms); } }
            function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[s])); }
            function toast(msg) { toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), 1500); }

            // Diagnostics
            try {
                console.log('[FSGS App] foods in localStorage:', JSON.parse(localStorage.getItem(STORAGE_KEY))?.length ?? 0);
                console.log('[FSGS App] thresholds in localStorage:', JSON.parse(localStorage.getItem(THRESH_KEY)));
            } catch { }
        })();
    </script>
    <!-- === BEGIN: Barcode Scanner Module (same as I will inject in your file) === -->
    <!-- ZXing fallback (if BarcodeDetector API is not available) -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
    <style>
        .scanner-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999
        }

        .scanner-wrap {
            background: #121212;
            color: #eaeaea;
            border-radius: 16px;
            max-width: 680px;
            width: 92%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .5);
            overflow: hidden
        }

        .scanner-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a
        }

        .scanner-title {
            font-size: 1.1rem;
            font-weight: 600
        }

        .scanner-body {
            padding: 12px 16px
        }

        #scannerVideo {
            width: 100%;
            border-radius: 12px;
            background: #000
        }

        .scanner-footer {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid #2a2a2a
        }

        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff
        }

        .btn-ghost {
            background: transparent;
            color: #eaeaea;
            border: 1px solid #2a2a2a
        }

        .btn-danger {
            background: #ef4444;
            color: #fff
        }

        .hint {
            font-size: 0.85rem;
            opacity: .8
        }

        .scanner-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .scanner-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #2a2a2a;
            background: #0e0e0e;
            color: #eaeaea
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #1f2937;
            color: #e5e7eb;
            font-size: .85rem
        }

        .chip code {
            font-size: .85rem
        }

        .torch-toggle {
            display: none
        }

        #torchSwitchLabel {
            display: flex;
            align-items: center;
            gap: 6px
        }

        .scan-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            border: 2px dashed rgba(255, 255, 255, .25);
            border-radius: 12px;
            margin: 12px
        }
    </style>
    <div aria-hidden="true" class="scanner-backdrop" id="barcodeScannerModal">
        <div aria-labelledby="scannerTitle" aria-modal="true" class="scanner-wrap" role="dialog">
            <div class="scanner-header">
                <div class="scanner-title" id="scannerTitle">Scan a product barcode</div>
                <button class="btn btn-ghost" id="closeScannerBtn" title="Close">âœ•</button>
            </div>
            <div class="scanner-body">
                <div style="position:relative">
                    <video autoplay="" id="scannerVideo" muted="" playsinline=""></video>
                    <div class="scan-overlay"></div>
                </div>
                <div class="scanner-row">
                    <span class="chip">Detected: <code id="detectedBarcode">â€”</code></span>
                    <button class="btn btn-primary" disabled="" id="lookupBtn">Lookup Ingredients</button>
                    <label class="chip" id="torchSwitchLabel">
                        <input class="torch-toggle" id="torchSwitch" type="checkbox" />
                        <span>Flashlight</span>
                    </label>
                    <label class="btn btn-primary" for="imageInput" style="display:inline-block;margin-top:10px;">ðŸ“·
                        Choose Barcode Image</label>
                    <input accept="image/*" id="imageInput" style="display:none;" type="file" />
                </div>
                <p class="hint">Tip: Aim for the UPC/EAN on the package. You can also pick a photo if the camera is
                    unavailable.</p>
            </div>
            <div class="scanner-footer">
                <button class="btn btn-ghost" id="switchCameraBtn">Switch camera</button>
                <div class="hint" id="scannerStatus">Ready</div>
                <button class="btn btn-danger" id="stopScannerBtn">Stop</button>
            </div>
        </div>
    </div>
    <script>
        (function () {
            const modal = document.getElementById('barcodeScannerModal');
            const video = document.getElementById('scannerVideo');
            const detectedEl = document.getElementById('detectedBarcode');
            const statusEl = document.getElementById('scannerStatus');
            const lookupBtn = document.getElementById('lookupBtn');
            const stopBtn = document.getElementById('stopScannerBtn');
            const closeBtn = document.getElementById('closeScannerBtn');
            const switchBtn = document.getElementById('switchCameraBtn');
            const imageInput = document.getElementById('imageInput');
            const torchSwitch = document.getElementById('torchSwitch');
            const torchLabel = document.getElementById('torchSwitchLabel');

            let currentStream = null;
            let currentDeviceId = null;
            let deviceList = [];
            let scanning = false;
            let track = null;
            let zxingReader = null;
            let useBarcodeDetector = ('BarcodeDetector' in window);
            let detectionIntervalId = null;

            async function enumerateCameras() {
                const devices = await navigator.mediaDevices.enumerateDevices();
                return devices.filter(d => d.kind === 'videoinput');
            }
            function showModal() { modal.style.display = 'flex'; modal.setAttribute('aria-hidden', 'false'); document.body.style.overflow = 'hidden'; }
            function hideModal() { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; }

            async function stopStream() {
                scanning = false;
                if (detectionIntervalId) { clearInterval(detectionIntervalId); detectionIntervalId = null; }
                if (track) { try { track.stop(); } catch (e) { } track = null; }
                if (currentStream) { currentStream.getTracks().forEach(t => { try { t.stop(); } catch (e) { } }); currentStream = null; }
                video.srcObject = null;
                statusEl.textContent = 'Stopped';
            }

            async function startStream(deviceId = null) {
                await stopStream();
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: deviceId ? undefined : { ideal: 'environment' },
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        width: { ideal: 1280 }, height: { ideal: 720 }
                    }
                };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                video.setAttribute('playsinline', true);
                track = currentStream.getVideoTracks()[0];
                currentDeviceId = track.getSettings().deviceId || deviceId || null;
                scanning = true;

                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                if (capabilities.torch) { torchLabel.style.display = 'inline-flex'; } else { torchLabel.style.display = 'none'; }

                if (useBarcodeDetector) {
                    const detector = new BarcodeDetector({ formats: ['ean_13', 'upc_a', 'upc_e', 'ean_8', 'code_128'] });
                    detectionIntervalId = setInterval(async () => {
                        if (!scanning) return;
                        try {
                            const barcodes = await detector.detect(video);
                            if (barcodes && barcodes.length) { onBarcode(barcodes[0].rawValue); }
                        } catch (e) {
                            if (zxingReader === null) {
                                useBarcodeDetector = false;
                                initZXing();
                            }
                        }
                    }, 200);
                } else {
                    initZXing();
                }
            }

            function initZXing() {
                try {
                    zxingReader = new ZXing.BrowserMultiFormatReader();
                    zxingReader.decodeFromVideoDevice(currentDeviceId || null, 'scannerVideo', (result, err) => {
                        if (result && scanning) { onBarcode(result.getText()); }
                    });
                } catch (e) { statusEl.textContent = 'ZXing init error'; }
            }

            function setTorch(on) {
                if (!track) return;
                try { track.applyConstraints({ advanced: [{ torch: !!on }] }); } catch (e) { }
            }

            async function onBarcode(value) {
                if (!value) return;
                scanning = false;
                detectedEl.textContent = value;
                lookupBtn.disabled = false;
                statusEl.textContent = 'Barcode detected';
                setTimeout(() => { scanning = true; }, 1200);
            }

            async function lookupIngredients(barcode) {
                statusEl.textContent = 'Looking up ingredients...';
                lookupBtn.disabled = true;
                try {
                    const resp = await fetch(`https://world.openfoodfacts.org/api/v2/product/${encodeURIComponent(barcode)}.json`);
                    const data = await resp.json();
                    let ingredientsText = null;
                    if (data && data.product) {
                        ingredientsText = data.product.ingredients_text || data.product.ingredients_text_en || null;
                        if (!ingredientsText && Array.isArray(data.product.ingredients)) {
                            ingredientsText = data.product.ingredients.map(i => i.text).join(', ');
                        }
                    }

                    // Update preview panel
                    (function () {
                        const previewBox = document.getElementById('ingredientPreview');
                        const previewText = document.getElementById('ingredientText');
                        if (previewBox && previewText) {
                            previewBox.style.display = 'block';
                            previewText.textContent = ingredientsText;
                        }
                    })();
                    if (!ingredientsText) {
                        statusEl.textContent = 'No ingredients found for this barcode.';
                        lookupBtn.disabled = false;
                        return;
                    }
                    let handedOff = false;
                    if (typeof window.ingestIngredientsFromText === 'function') {
                        window.ingestIngredientsFromText(ingredientsText, { source: 'barcode', barcode });
                        handedOff = true;
                    }
                    if (!handedOff && window.FFF && typeof window.FFF.ingestIngredients === 'function') {
                        window.FFF.ingestIngredients(ingredientsText, { source: 'barcode', barcode });
                        handedOff = true;
                    }
                    if (!handedOff) {
                        document.dispatchEvent(new CustomEvent('ingredients:from-scan', { detail: { text: ingredientsText, source: 'barcode', barcode } }));
                        const ta = document.querySelector('#ingredientsInput, textarea[name="ingredients"], textarea[data-role="ingredients"]');
                        if (ta) { ta.value = ingredientsText; ta.dispatchEvent(new Event('input', { bubbles: true })); }
                    }
                    statusEl.textContent = 'Ingredients imported.';
                } catch (e) {
                    console.error(e); statusEl.textContent = 'Lookup failed. Try again.'; lookupBtn.disabled = false;
                }
            }

            imageInput.addEventListener('change', async (ev) => {
                const file = ev.target.files && ev.target.files[0]; if (!file) return;
                try {
                    const url = URL.createObjectURL(file);
                    if (useBarcodeDetector) {
                        const img = new Image();
                        img.onload = async () => {
                            try {
                                const detector = new BarcodeDetector({ formats: ['ean_13', 'upc_a', 'upc_e', 'ean_8', 'code_128'] });
                                const res = await detector.detect(img);
                                if (res && res.length) { onBarcode(res[0].rawValue); } else { statusEl.textContent = 'No barcode found in image.'; }
                            } catch (e) { statusEl.textContent = 'Image decode failed.'; }
                            finally { URL.revokeObjectURL(url); }
                        };
                        img.src = url;
                    } else {
                        const codeReader = new ZXing.BrowserBarcodeReader();
                        const result = await codeReader.decodeFromImageUrl(url);
                        URL.revokeObjectURL(url);
                        if (result) { onBarcode(result.text); } else { statusEl.textContent = 'No barcode found in image.'; }
                    }
                } catch (e) { statusEl.textContent = 'Image decode error.'; }
            });

            lookupBtn.addEventListener('click', () => {
                const code = detectedEl.textContent && detectedEl.textContent.trim();
                if (code && code !== 'â€”') lookupIngredients(code);
            });
            stopBtn.addEventListener('click', stopStream);
            closeBtn.addEventListener('click', async () => { await stopStream(); hideModal(); });
            switchBtn.addEventListener('click', async () => {
                deviceList = await enumerateCameras();
                if (!deviceList.length) return;
                if (!currentDeviceId) { currentDeviceId = deviceList[0].deviceId; }
                const idx = deviceList.findIndex(d => d.deviceId === currentDeviceId);
                const next = deviceList[(idx + 1) % deviceList.length];
                await startStream(next.deviceId);
            });
            torchSwitch.addEventListener('change', (e) => setTorch(e.target.checked));

            modal.addEventListener('click', async (e) => { if (e.target === modal) { await stopStream(); hideModal(); } });

            window.openBarcodeScanner = async function () {
                try {
                    showModal();
                    statusEl.textContent = 'Requesting camera...';
                    deviceList = await enumerateCameras();
                    await startStream(null);
                    statusEl.textContent = 'Scanning...';
                } catch (e) {
                    console.error(e);
                    statusEl.textContent = 'Camera unavailable. Pick an image below.';
                }
            };

            document.addEventListener('keydown', async (e) => {
                if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') { await stopStream(); hideModal(); }
            });
            document.addEventListener('visibilitychange', async () => {
                if (document.hidden && modal.getAttribute('aria-hidden') === 'false') { await stopStream(); }
            });
        })();
    </script>
    <!-- === END: Barcode Scanner Module === -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const scanBtn = document.getElementById('btn-scan');
            if (scanBtn && typeof window.openBarcodeScanner === 'function') {
                scanBtn.addEventListener('click', () => window.openBarcodeScanner());
            }
        });


        // Hook into scanner result to populate Add panel with barcode data
        window.ingestIngredientsFromText = function (text, meta) {
            if (!text || !meta || !meta.barcode) return;

            // Fetch product info again from Open Food Facts to get full details
            fetch(`https://world.openfoodfacts.org/api/v2/product/${meta.barcode}.json`)
                .then(resp => resp.json())
                .then(data => {
                    if (!data || !data.product) return;

                    const p = data.product;
                    const nutr = p.nutriments || {};
                    const newItem = {
                        name: p.product_name || "",
                        ingredients: p.ingredients_text || p.ingredients_text_en || text || "",
                        serving: p.serving_size || "",
                        sodium_mg: Math.round((nutr.sodium_100g || 0) * 100),  // sodium in g â†’ mg
                        sugar_g: nutr.sugars_100g || 0,
                        potassium_mg: nutr.potassium_100g ? Math.round(nutr.potassium_100g * 1000) : 0,
                        phosphorus_mg: nutr.phosphorus_100g ? Math.round(nutr.phosphorus_100g * 1000) : 0,
                        protein_g: nutr.proteins_100g || 0,
                        calories_kcal: nutr.energy_kcal_100g || nutr.energy_100g || 0,
                        carbs_g: nutr.carbohydrates_100g || 0,
                        fat_g: nutr.fat_100g || 0,
                        fiber_g: nutr.fiber_100g || 0,
                        cholesterol_mg: 0,
                        calcium_mg: nutr.calcium_100g ? Math.round(nutr.calcium_100g * 1000) : 0,
                        magnesium_mg: nutr.magnesium_100g ? Math.round(nutr.magnesium_100g * 1000) : 0,
                        vitamin_d_mcg: nutr.vitamin_d_100g || 0,
                        tags: [],
                        notes: `Scanned from barcode ${meta.barcode}`
                    };

                    // Open the Add panel with values filled in
                    if (typeof window.openAddPanel === 'function') {
                        window.openAddPanel(newItem);
                    } else {
                        console.warn("openAddPanel not found.");
                    }
                })
                .catch(err => console.error("Barcode lookup failed:", err));
        };

    </script>
    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("service-worker.js").then(() => {
                    console.log("Service Worker registered");
                }).catch(err => {
                    console.error("Service Worker registration failed:", err);
                });
            });
        }
    </script>
</body>

</html>